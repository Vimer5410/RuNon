@page "/a"
@using Microsoft.AspNetCore.SignalR.Client
@using RuNon_Client.Services
@using RuNon_Client.Components.Pages 
@inject MatchMakingService _matchMakingService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inherits RuNon_Client.Components.Pages.ChatBase
@rendermode InteractiveServer


<head>
    <link rel="icon" type="image/x-icon" href="images/favicon.png" />
    <link rel="shortcut icon" type="image/x-icon" href="images/favicon.png" />
    <title>Голосовой чат</title>
</head>

<div class="chat-container">
    @* Заголовок приложения *@
            <div class="header-section">
                <h1 class="header-title">
                    <i class="fas fa-headset"></i> 
                    Анонимный **Войс** Чат
                </h1>
                <div class="header-subtitle">Найди собеседника по интересам</div>
            </div>
    
            @* статус подключения *@
            <div class="status-card">
                @{
                        var state = hubConnection?.State;
                        
                        string statusClass = state == HubConnectionState.Connected ? "status-connected" :
                        state == HubConnectionState.Connecting ? "status-connecting" : "status-disconnected";
                        
                        string statusText = state == HubConnectionState.Connected ? "Подключен" :
                        state == HubConnectionState.Connecting ? "Подключение..." : "Отключен";
                        
                        string statusIcon = state == HubConnectionState.Connected ? "fa-wifi" :
                        state == HubConnectionState.Connecting ? "fa-spinner fa-spin" : "fa-wifi-slash";
                }
                <div class="connection-status">
                    <div class="status-indicator @statusClass"></div>
                    <div class="status-info">
                        <i class="fas @statusIcon"></i>
                        <span>@statusText</span>
                    </div>
                </div>
    
                <div class="connection-info">
                    <div class="connection-label">
                        <i class="fas fa-id-card"></i>
                        Ваш ID: <code class="connection-id">@(yourClientID ?? "Не подключен")</code>
                    </div>
                    @if (!string.IsNullOrEmpty(userIp))
                    {
                         <div style="font-size: 0.8em; color: #666; margin-top: 5px;">IP: @userIp</div>
                    }
                </div>
            </div>
    
            @* Основная сетка *@
    <div class="main-grid">
        @* панель фильтров (Оставлена без изменений) *@
        <div class="filters-panel">
            <div class="panel-header">
                <i class="fas fa-search"></i>
                <h3>Поиск собеседника</h3>
            </div>
    
            <div class="filter-section">
                <div class="section-title">Мои данные</div>
    
                <div class="filter-group">
                    <label class="filter-label">Мой пол:</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="myGender" value="male" checked="@(myGender == "male")" @onchange="@((e) => myGender = "male")">
                            <span class="radio-custom"></span>
                            <i class="fas fa-mars gender-icon male"></i>
                            М
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="myGender" value="female" checked="@(myGender == "female")" @onchange="@((e) => myGender = "female")">
                            <span class="radio-custom"></span>
                            <i class="fas fa-venus gender-icon female"></i>
                            Ж
                        </label>
                    </div>
                </div>
    
                <div class="filter-group">
                    <label class="filter-label">Мой возраст:</label>
                    <select class="filter-select" @onchange="@((e) => myAge = int.Parse(e.Value.ToString()))">
                        <option value="16">16 лет</option>
                        @for (int i = 17; i <= 60; i++)
                        {
                            <option value="@i">@i лет</option>
                        }
                    </select>
                </div>
            </div>
    
            <div class="filter-section">
                <div class="section-title">Ищу собеседника</div>
                <div class="filter-group">
                    <label class="filter-label">Пол собеседника:</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="targetGender" value="male" checked="@(targetGender == "male")" @onchange="@((e) => targetGender = "male")">
                            <span class="radio-custom"></span>
                            <i class="fas fa-mars gender-icon male"></i>
                            М
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="targetGender" value="female" checked="@(targetGender == "female")" @onchange="@((e) => targetGender = "female")">
                            <span class="radio-custom"></span>
                            <i class="fas fa-venus gender-icon female"></i>
                            Ж
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="targetGender" value="any" checked="@(targetGender == "any")" @onchange="@((e) => targetGender = "any")">
                            <span class="radio-custom"></span>
                            <i class="fas fa-users gender-icon"></i>
                            Любой
                        </label>
                    </div>
                </div>
    
                <div class="filter-group">
                                         <label class="filter-label">Возраст собеседника:</label>
                    <select class="filter-select" @onchange="@((e) => partnerAge = int.Parse(e.Value.ToString()))">
                        <option value="16">16 лет</option>
                        @for (int i = 17; i <= 60; i++)
                        {
                            <option value="@i">@i лет</option>
                        }
                    </select>
                 </div>
            </div>
    
            <div class="search-actions">
                         
                <button class="search-btn primary" @onclick="StartSearch" disabled="@((hubConnection?.State != HubConnectionState.Connected) || isSearching || !string.IsNullOrEmpty(interviewerClientID))">
                    <i class="fas fa-search"></i>
                    Начать поиск
                </button>
                         
                <button class="search-btn secondary" @onclick="StopSearch" disabled="@(!isSearching)">
                    <i class="fas fa-stop"></i>
                    Остановить
                </button>
            </div>
    
            
        </div>
    
        @* основная область чата (Изменено для Войс Чата) *@
        <div class="chat-area">
            @* isCallActive - предполагаемое состояние, что P2P соединение установлено *@
            @if (!string.IsNullOrEmpty(interviewerClientID))
            {
                <div class="voice-chat-active">
                    
                    @* Аватар и Индикатор активности собеседника *@
                    <div class="partner-call-info @(isPartnerSpeaking ? "speaking" : "")">
                        <div class="partner-avatar">
                            @* Тут можно использовать более нейтральный аватар или заглушку *@
                            <i class="fas fa-user-secret"></i>
                        </div>
                        <div class="partner-details">
                            <div class="partner-name">Собеседник найден!</div>
                            <div class="call-status-text">
                                <i class="fas fa-headset"></i> **Идет разговор...**
                            </div>
                        </div>
                        @* Визуализация голоса (простая) *@
                        <div class="partner-voice-indicator">
                            <div class="voice-bar bar-1"></div>
                            <div class="voice-bar bar-2"></div>
                            <div class="voice-bar bar-3"></div>
                        </div>
                    </div>

                    @* Таймер звонка *@
                    <div class="call-timer">
                        <i class="fas fa-clock"></i>
                        <span>@callTimer</span> @* Нужно реализовать логику обновления в C# *@
                    </div>
    
                    @* Элементы управления звонком *@
                    <div class="call-controls">
                        @* Кнопка микрофона *@
                        <button class="control-btn mic-toggle @(isLocalMicMuted ? "muted" : "")" 
                                @onclick="ToggleMicMute" 
                                title="@(isLocalMicMuted ? "Включить микрофон" : "Выключить микрофон")">
                            <i class="fas @(isLocalMicMuted ? "fa-microphone-slash" : "fa-microphone")"></i>
                        </button>
    
                        @* Кнопка завершения чата *@
                        <button class="control-btn end-call-btn" 
                                @onclick="DisconnectFromPartner" 
                                title="Завершить голосовой чат">
                            <i class="fas fa-phone-slash"></i>
                            **Завершить**
                        </button>

                        @* Кнопка отключения динамика (опционально) *@
                        @* <button class="control-btn speaker-toggle" title="Отключить звук собеседника">
                            <i class="fas fa-volume-up"></i>
                        </button> *@
                    </div>
                    
                    <div class="partner-id-footer">
                         Анонимный ID собеседника: **@interviewerClientID**
                    </div>
                </div>
            }
            else
            {
                
                @* состояние без активного чата (Оставлено без изменений) *@
                <div class="no-chat-state">
                    
                    @if (isSearching)
                    {
                        <div class="search-status">
                            <div class="search-animation">
                                <div class="search-dot"></div>
                                <div class="search-dot"></div>
                                <div class="search-dot"></div>
                                </div>
                            <div class="search-text">Ищем собеседника...</div>
                            </div>
                    }
                    else
                    {
                        <div class="no-chat-icon">
                            <i class="fas fa-headset"></i> @* Обновил иконку *@
                        </div>
                        <div class="no-chat-title">Готов к голосовому общению?</div>
                        <div class="no-chat-description">
                            Настройте фильтры и нажмите "**Начать поиск**"
                        </div>
                    }
                    
                    
                </div>
                
                
            }
        </div>
    </div>
</div>

@* Модальное окно бана (Оставлено без изменений) *@
@if (isUserBanned)
{
    <div class="ban-system-overlay">
        <div class="ban-system-modal">
            <div class="ban-system-header">
                <div class="ban-system-icon">
                    <i class="fas fa-ban"></i>
                </div>
                <h2 class="ban-system-title">Доступ ограничен</h2>
                <div class="ban-system-subtitle">Ваш аккаунт был заблокирован администрацией</div>
            </div>
            
            <div class="ban-system-content">
                <div class="ban-system-info-card">
                    <div class="ban-system-detail">
                        <div class="ban-system-detail-label">
                            <i class="fas fa-exclamation-triangle"></i>
                            Причина блокировки:
                        </div>
                        <div class="ban-system-detail-value">Нарушение правил сообщества</div>
                    </div>
                    
                    <div class="ban-system-detail">
                        <div class="ban-system-detail-label">
                            <i class="fas fa-clock"></i>
                            Дата блокировки:
                        </div>
                        <div class="ban-system-detail-value">-----</div>
                    </div>
                    
                    <div class="ban-system-detail">
                        <div class="ban-system-detail-label">
                            <i class="fas fa-id-card"></i>
                            Ваш ID:
                        </div>
                        <div class="ban-system-detail-value">@yourClientID</div>
                    </div>
                </div>
                
                <div class="ban-system-message">
                    <p>К сожалению, вы не можете участвовать в чате. Если считаете, что это ошибка, обратитесь в техподдержку.</p>
                </div>
                
                <div class="ban-system-actions">
                    <button class="ban-system-btn ban-system-secondary" @onclick="BanReboot_Btn">
                        <i class="fas fa-sync-alt"></i>
                        Перезагрузить
                    </button>
                    <button class="ban-system-btn ban-system-primary" @onclick="BanSendTechSupport_Btn">
                        <i class="fas fa-headset"></i>
                        Техподдержка
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@* Toast уведомление (Оставлено без изменений) *@
<div class="toast-container @(ShowToast ? "show" : "")">
    <div class="toast-message">
        <i class="fas fa-check-circle"></i>
        ✅ Ваша заявка принята
    </div>
</div>


@code
{
    
    // Состояние звонка
    private bool isCallActive = false; // true, когда собеседник найден и звонок установлен
    private bool isLocalMicMuted = false; // Состояние микрофона пользователя
    private bool isPartnerSpeaking = false; // Индикатор, говорит ли собеседник
    private string callTimer = "00:00"; // Таймер звонка
    
    private bool isSearching = false;
    
    private string myGender = "male";
    private int myAge = 16;
    
    private string targetGender = "any";
    private int partnerAge = 16;
    
    //матчмейкинг

    private (string?, string?) pair;
    
    
    private async Task StartSearch()
    {
        // проверяем что нельзя начать поиск без своего ID
        if(string.IsNullOrEmpty(yourClientID)) return;

        isSearching = true;
        
        _matchMakingService.AddToQueue(yourClientID, myGender, myAge.ToString(), targetGender, partnerAge.ToString());
        
        
        while (isSearching)
        {
            pair = _matchMakingService.SearchCommand(yourClientID);
            // ищем Id собеседника
            if (!string.IsNullOrEmpty(pair.Item1) && pair.Item1 != yourClientID)
            {
                interviewerClientID = pair.Item1;
                isSearching = false;
            }
            else if (!string.IsNullOrEmpty(pair.Item2) && pair.Item2 != yourClientID)
            {
                interviewerClientID = pair.Item2;
                isSearching = false;
            }
            
            await InvokeAsync(StateHasChanged);
            await Task.Delay(1000);
        }
        
    }

    // останавливаем поиск
    private void StopSearch()
    {
        isSearching = false;
        if (!string.IsNullOrEmpty(yourClientID))
        {
            _matchMakingService.RemoveFromQueue(yourClientID);
        }
        pair = (null, null); // Сбрасываем найденную пару
        StateHasChanged();
    }

    // выходим из чата с собеседником
    private async Task DisconnectFromPartner()
    {
        if (!string.IsNullOrEmpty(interviewerClientID))
        {
            await hubConnection.InvokeAsync("NotifyOfLeave", interviewerClientID);
        }
        interviewerClientID = null;
        isSearching = false;
        StateHasChanged();
    }

    
    private void ToggleMicMute()
    {
        throw new NotImplementedException();
    }
    
    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
            await DisconnectFromPartner();
            await hubConnection.DisposeAsync();
        }
        dotNetRef?.Dispose();
    }
    
}
