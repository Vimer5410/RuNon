@page "/a"
@using Microsoft.AspNetCore.SignalR.Client
@using RuNon_Client.Services
@using RuNon_Client.Components.Pages 
@inject MatchMakingService _matchMakingService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable
@inherits RuNon_Client.Components.Pages.ChatBase
@rendermode InteractiveServer




<div class="chat-container">
            @* Заголовок приложения *@
            <div class="header-section">
                <h1 class="header-title">
                    <i class="fas fa-headset"></i> 
                    Анонимный Войс Чат
                </h1>
                <div class="header-subtitle">Найди собеседника по интересам</div>
            </div>
            
            @* статус подключения *@
            <div class="status-card" style="position: relative;">
                
                <div class="online-status-absolute">
                    <span class="info-label">Сейчас общаются в чате : </span>
                    <span class="online-count-value">@usersOnline</span>
                </div>
            
                @{
                    var state = hubConnection?.State;
                    
                    string statusClass = state == HubConnectionState.Connected ? "status-connected" :
                    state == HubConnectionState.Connecting ? "status-connecting" : "status-disconnected";
                    
                    string statusText = state == HubConnectionState.Connected ? "Подключен" :
                    state == HubConnectionState.Connecting ? "Подключение..." : "Отключен";
                    
                    string statusIcon = state == HubConnectionState.Connected ? "fa-wifi" :
                    state == HubConnectionState.Connecting ? "fa-spinner fa-spin" : "fa-wifi-slash";
                }
            
                <div class="connection-status">
                    <div class="status-left-group">
                        <div class="status-indicator @statusClass"></div>
                        <div class="status-info">
                            <i class="fas @statusIcon"></i>
                            <span>@statusText</span>
                        </div>
                    </div>
                </div>
            
                <div class="connection-info">
                    <div class="connection-label">
                        <i class="fas fa-id-card"></i>
                        Ваш ID: <code class="connection-id">@(yourClientID ?? "Не подключен")</code>
                    </div>
                    @if (!string.IsNullOrEmpty(userIp))
                    {
                        <div style="font-size: 0.8em; color: #666; margin-top: 5px;">IP: @userIp</div>
                    }
                </div>
            </div>
            @* Основная сетка *@
    <div class="main-grid">
        @* панель фильтров (Оставлена без изменений) *@
        <div class="filters-panel">
            <div class="panel-header">
                <i class="fas fa-search"></i>
                <h3>Поиск собеседника</h3>
            </div>
    
            <div class="filter-section">
                <div class="section-title">Мои данные</div>
    
                <div class="filter-group">
                    <label class="filter-label">Мой пол:</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="myGender" value="male" checked="@(myGender == "male")" @onchange="@((e) => myGender = "male")">
                            <span class="radio-custom"></span>
                            <i class="fas fa-mars gender-icon male"></i>
                            М
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="myGender" value="female" checked="@(myGender == "female")" @onchange="@((e) => myGender = "female")">
                            <span class="radio-custom"></span>
                            <i class="fas fa-venus gender-icon female"></i>
                            Ж
                        </label>
                    </div>
                </div>
    
                <div class="filter-group">
                    <label class="filter-label">Мой возраст:</label>
                    <select class="filter-select" @onchange="@((e) => myAge = int.Parse(e.Value.ToString()))">
                        <option value="16">16 лет</option>
                        @for (int i = 17; i <= 60; i++)
                        {
                            <option value="@i">@i лет</option>
                        }
                    </select>
                </div>
            </div>
    
            <div class="filter-section">
                <div class="section-title">Ищу собеседника</div>
                <div class="filter-group">
                    <label class="filter-label">Пол собеседника:</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="targetGender" value="male" checked="@(targetGender == "male")" @onchange="@((e) => targetGender = "male")">
                            <span class="radio-custom"></span>
                            <i class="fas fa-mars gender-icon male"></i>
                            М
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="targetGender" value="female" checked="@(targetGender == "female")" @onchange="@((e) => targetGender = "female")">
                            <span class="radio-custom"></span>
                            <i class="fas fa-venus gender-icon female"></i>
                            Ж
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="targetGender" value="any" checked="@(targetGender == "any")" @onchange="@((e) => targetGender = "any")">
                            <span class="radio-custom"></span>
                            <i class="fas fa-users gender-icon"></i>
                            Любой
                        </label>
                    </div>
                </div>
    
                <div class="filter-group">
                                         <label class="filter-label">Возраст собеседника:</label>
                    <select class="filter-select" @onchange="@((e) => partnerAge = int.Parse(e.Value.ToString()))">
                        <option value="16">16 лет</option>
                        @for (int i = 17; i <= 60; i++)
                        {
                            <option value="@i">@i лет</option>
                        }
                    </select>
                 </div>
            </div>
    
            <div class="search-actions">
                         
                <button class="search-btn primary" @onclick="StartSearch" disabled="@((hubConnection?.State != HubConnectionState.Connected) || isSearching || !string.IsNullOrEmpty(interviewerClientID))">
                    <i class="fas fa-search"></i>
                    Начать поиск
                </button>
                         
                <button class="search-btn secondary" @onclick="StopSearch" disabled="@(!isSearching)">
                    <i class="fas fa-stop"></i>
                    Остановить
                </button>
            </div>
    
            
        </div>
    
        
        <div class="chat-area">
            @if (!string.IsNullOrEmpty(interviewerClientID))
            {
                @* информация о текущем собеседнике *@
                <div class="partner-info">
                    <div class="partner-avatar">
                        @switch (avatarNumber)
                        {
                            case 1:
                                <img class="local-avatar-img" src="images/ava_1.png"/>
                                break;
                            case 2:
                                <img class="local-avatar-img" src="images/ava_2.png"/>
                                break;
                            case 3:
                                <img class="local-avatar-img" src="images/ava_3.png"/>
                                break;
                        }
                        
                        <i class="fas fa-user-secret"></i>
                    </div>
                    <div class="partner-details">
                        <div class="partner-name">Собеседник найден!</div>
                        <div class="partner-stats">
                            ID: @interviewerClientID
                        </div>
                    </div>
                </div>
        
               <div class="voice-chat-content">
    
    @* Аватар и Индикатор активности собеседника *@
    <div class="partner-call-card @(isPartnerSpeaking ? "speaking" : "")">
        <div class="partner-call-avatar">
            <i class="fas fa-user-secret"></i>
            @* Эффект пульсации (как в дискорде) *@
            <div class="pulse-ring"></div>
        </div>
        
        <div class="partner-call-details">
            <h3 class="partner-call-name">Аноним</h3>
            <div class="call-status-badge">
                <i class="fas fa-signal"></i>
                <span>Идет разговор...</span>
            </div>
        </div>

        @* Визуализация голоса *@
        <div class="voice-visualizer">
            <div class="voice-bar bar-1"></div>
            <div class="voice-bar bar-2"></div>
            <div class="voice-bar bar-3"></div>
            <div class="voice-bar bar-4"></div>
            <div class="voice-bar bar-5"></div>
        </div>
    </div>

    @* Таймер звонка *@
    <div class="voice-timer-display">
        <i class="far fa-clock"></i>
        <span>@callTimer</span>
    </div>

    @* Элементы управления звонком *@
    <div class="voice-controls-panel">
       @* Кнопка микрофона с PNG картинкой *@
       <button class="control-circle-btn mic-btn @(isLocalMicMuted ? "muted" : "")" 
               @onclick="ToggleMicMute" 
               title="@(isLocalMicMuted ? "Включить микрофон" : "Выключить микрофон")">
           
           <img src="images/mic_mute_1.png" class="mic-png-icon" alt="Mic" />
           
           @if (isLocalMicMuted)
           {
               <div class="mute-cross-line"></div>
           }
       </button>

        @* Кнопка завершения звонка *@
        <button class="action-btn-large end-call-btn" 
                @onclick="DisconnectFromPartner" 
                title="Завершить голосовой чат">
            <i class="fas fa-phone-slash"></i>
            <span>Завершить</span>
        </button>
    </div>
    
</div>
            
            }
            else
            {
                @* состояние без активного чата *@
                <div class="no-chat-state">
                    @if (isSearching)
                    {
                        <div class="search-status">
                            <div class="search-animation">
                                <div class="search-dot"></div>
                                <div class="search-dot"></div>
                                <div class="search-dot"></div>
                            </div>
                            <div class="search-text">Ищем собеседника...</div>
                        </div>
                    }
                    else
                    {
                        <div class="no-chat-icon">
                            <i class="fas fa-headset"></i>
                        </div>
                        <div class="no-chat-title">Готов к голосовому общению?</div>
                        <div class="no-chat-description">
                            Заполните фильтры поиска и нажмите 
                            "Начать поиск"
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>

@* Модальное окно бана (Оставлено без изменений) *@
@if (isUserBanned)
{
    <div class="ban-system-overlay">
        <div class="ban-system-modal">
            <div class="ban-system-header">
                <div class="ban-system-icon">
                    <i class="fas fa-ban"></i>
                </div>
                <h2 class="ban-system-title">Доступ ограничен</h2>
                <div class="ban-system-subtitle">Ваш аккаунт был заблокирован администрацией</div>
            </div>
            
            <div class="ban-system-content">
                <div class="ban-system-info-card">
                    <div class="ban-system-detail">
                        <div class="ban-system-detail-label">
                            <i class="fas fa-exclamation-triangle"></i>
                            Причина блокировки:
                        </div>
                        <div class="ban-system-detail-value">Нарушение правил сообщества</div>
                    </div>
                    
                    <div class="ban-system-detail">
                        <div class="ban-system-detail-label">
                            <i class="fas fa-clock"></i>
                            Дата блокировки:
                        </div>
                        <div class="ban-system-detail-value">-----</div>
                    </div>
                    
                    <div class="ban-system-detail">
                        <div class="ban-system-detail-label">
                            <i class="fas fa-id-card"></i>
                            Ваш ID:
                        </div>
                        <div class="ban-system-detail-value">@yourClientID</div>
                    </div>
                </div>
                
                <div class="ban-system-message">
                    <p>К сожалению, вы не можете участвовать в чате. Если считаете, что это ошибка, обратитесь в техподдержку.</p>
                </div>
                
                <div class="ban-system-actions">
                    <button class="ban-system-btn ban-system-secondary" @onclick="BanReboot_Btn">
                        <i class="fas fa-sync-alt"></i>
                        Перезагрузить
                    </button>
                    <button class="ban-system-btn ban-system-primary" @onclick="BanSendTechSupport_Btn">
                        <i class="fas fa-headset"></i>
                        Техподдержка
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@* Toast уведомление (Оставлено без изменений) *@
<div class="toast-container @(ShowToast ? "show" : "")">
    <div class="toast-message">
        <i class="fas fa-check-circle"></i>
        ✅ Ваша заявка принята
    </div>
</div>


@code
{
    private bool isLocalSpeaking = true;
    
    // Состояние звонка
    private bool isLocalMicMuted = false; // Состояние микрофона пользователя
    private bool isPartnerSpeaking = false; // Индикатор, говорит ли собеседник
    private DateTime now = Convert.ToDateTime(DateTime.Now.ToString("T")); // Таймер звонка
    private string callTimer;
    
    private bool isSearching = false;
    
    private string myGender = "male";
    private int myAge = 16;
    
    private string targetGender = "any";
    private int partnerAge = 16;
    
    //матчмейкинг

    private (string?, string?) pair;
    
    //выбор случайной аватарки пользователя
    private int avatarNumber=1;
    
    private async Task StartSearch()
    {
        callTimer = "00:00"; // обнуляем таймер, чтобы не было бага остаточного значения
        avatarNumber = new Random().Next(1, 4); // выбираем рандомную аватарку
        // проверяем что нельзя начать поиск без своего ID
        if(string.IsNullOrEmpty(yourClientID)) return;

        isSearching = true;
        
        _matchMakingService.AddToQueue(yourClientID, myGender, myAge.ToString(), targetGender, partnerAge.ToString());
        
        
        while (isSearching)
        {
            pair = _matchMakingService.SearchCommand(yourClientID);
            // ищем Id собеседника
            if (!string.IsNullOrEmpty(pair.Item1) && pair.Item1 != yourClientID)
            {
                interviewerClientID = pair.Item1;
                isSearching = false;
            }
            else if (!string.IsNullOrEmpty(pair.Item2) && pair.Item2 != yourClientID)
            {
                interviewerClientID = pair.Item2;
                isSearching = false;
            }
            
            await InvokeAsync(StateHasChanged);
            await Task.Delay(1000);
        }
        roomId = GetUniqueRoomId(pair.Item1, pair.Item2);
        
        await JoinRoom();
        
        await StartClock(); //запускаем таймер

    }

    // останавливаем поиск
    private async Task StopSearch()
    {
        isSearching = false;
        if (!string.IsNullOrEmpty(yourClientID))
        {
            _matchMakingService.RemoveFromQueue(yourClientID);
        }
        pair = (null, null); // Сбрасываем найденную пару
        StateHasChanged();
    }

    // выходим из чата с собеседником
    private async Task DisconnectFromPartner()
    {
        try
        {
            if (!string.IsNullOrEmpty(interviewerClientID))
            {
                await hubConnection.InvokeAsync("NotifyOfLeave", interviewerClientID);
            }
            
            interviewerClientID = null;
            isSearching = false;
            
            if (JSRuntime is not null)
            {
                try
                {   await JSRuntime.InvokeVoidAsync("VoiceChat.leaveRoom"); }
                catch { }
            }
            StateHasChanged();
        }
        catch (Exception e)
        {
            Console.WriteLine(e);
            throw;
        }
        
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            if (hubConnection is not null)
            {
                await DisconnectFromPartner();
                await hubConnection.DisposeAsync();
                await StopSearch();
                dotNetRef?.Dispose();
            }
        }
        catch { }
        
    }
    
    private async Task ToggleMicMute()
    {
        isLocalSpeaking = false;
        isPartnerSpeaking = true;
        await Task.Delay(10000);
        isPartnerSpeaking = false;
    }
    
    
    private async Task StartClock()
    {
        now = DateTime.Now; 
        
        while (!string.IsNullOrEmpty(interviewerClientID))
        {
            callTimer = (DateTime.Now - now).ToString(@"mm\:ss");
            StateHasChanged();
            await Task.Delay(1000);
        }
    }
    
}
