@page "/"
@using Microsoft.AspNetCore.SignalR.Client
@using System.Security.Cryptography
@using System.Text
@using System.Net
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using Microsoft.Data.Sqlite



@rendermode InteractiveServer

<div class="chat-container"  >
    @* Заголовок приложения *@
    <div class="header-section">
        <h1 class="header-title">
            <i class="fas fa-user-secret"></i>
            Анонимный Чат
        </h1>
        <div class="header-subtitle">Найди собеседника по интересам</div>
    </div>

    @* Статус подключения *@
    <div class="status-card">
        <div class="connection-status">
            @{
                string statusClass = hubConnection?.State == HubConnectionState.Connected ? "status-connected" : 
                                   hubConnection?.State == HubConnectionState.Connecting ? "status-connecting" : "status-disconnected";
                string statusText = hubConnection?.State == HubConnectionState.Connected ? "Подключен" : 
                                  hubConnection?.State == HubConnectionState.Connecting ? "Подключение..." : "Отключен";
                string statusIcon = hubConnection?.State == HubConnectionState.Connected ? "fa-wifi" : 
                                  hubConnection?.State == HubConnectionState.Connecting ? "fa-spinner fa-spin" : "fa-wifi-slash";
            }
            <div class="status-indicator @statusClass"></div>
            <div class="status-info">
                <i class="fas @statusIcon"></i>
                <span>@statusText</span>
            </div>
        </div>
        
        <div class="connection-info">
            <div class="connection-label">
                <i class="fas fa-id-card"></i>
                Ваш ID: <code class="connection-id">@(yourClientID ?? "Не подключен")</code>
            </div>
        </div>
    </div>

    @* Основная сетка с настройками и чатом *@
    <div class="main-grid">
        <div class="filters-panel">
            <div class="panel-header">
                <i class="fas fa-cog"></i>
                <h3>Настройки чата</h3>
            </div>
            
            <div class="filter-section">
                <div class="section-title">Получатель</div>
                
                <div class="filter-group">
                    <label class="filter-label">ID получателя:</label>
                    <textarea 
                        @bind="interviewerСlientID" 
                        class="filter-textarea" 
                        placeholder="Введите ID получателя...">
                    </textarea>
                </div>
            </div>

            <div class="connection-details">
                <div class="detail-item">
                    <i class="fas fa-globe"></i>
                    <span>IP: @userIp</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-shield-alt"></i>
                    <span>Шифрование: @(publicKeyFromServer != null ? "Активно" : "Ожидание...")</span>
                </div>
            </div>
        </div>

        @* Основная область чата *@
        <div class="chat-area">
            <div class="chat-header">
                <div class="chat-title">
                    <i class="fas fa-comments"></i>
                    <span>Окно чата</span>
                </div>
                <div class="chat-status-badge">
                    @(hubConnection?.State == HubConnectionState.Connected ? "Активен" : "Неактивен")
                </div>
            </div>

            @* Область сообщений *@
            <div class="messages-area" id="chatMessages">
                @if (receiveUserMessage != null && receiveUserMessage.Any())
                {
                    @foreach (var receiveMsg in receiveUserMessage)
                    {
                        <div class="message @(receiveMsg.isMine ? "my-message" : "partner-message")">
                            <div class="message-content">
                                @receiveMsg.message
                            </div>
                            <div class="message-time">
                                @DateTime.Now.ToString("HH:mm")
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="no-chat-state">
                        <div class="no-chat-icon">
                            <i class="fas fa-comments"></i>
                        </div>
                        <div class="no-chat-title">Начните беседу</div>
                        <div class="no-chat-description">
                            Введите ID получателя и отправьте первое сообщение
                        </div>
                    </div>
                }
            </div>

            @* Поле ввода сообщения *@
            <div class="message-input-area">
                <div class="input-group">
                    <textarea 
                        @bind="messagetext" 
                        @bind:event="oninput"
                        @onkeyup="EnterKeyDown"
                        class="message-input" 
                        placeholder="Введите сообщение..."
                        rows="1">
                    </textarea>
                    <button 
                        @onclick="SendTestMessage" 
                        class="send-btn"
                        disabled="@(hubConnection?.State != HubConnectionState.Connected || isUserBanned)">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>


@if (isUserBanned)
{
    <div class="ban-system-overlay">
        <div class="ban-system-modal">
            <div class="ban-system-header">
                <div class="ban-system-icon">
                    <i class="fas fa-ban"></i>
                </div>
                <h2 class="ban-system-title">Доступ ограничен</h2>
                <div class="ban-system-subtitle">Ваш аккаунт был заблокирован администрацией</div>
            </div>
            
            <div class="ban-system-content">
                <div class="ban-system-info-card">
                    <div class="ban-system-detail">
                        <div class="ban-system-detail-label">
                            <i class="fas fa-exclamation-triangle"></i>
                            Причина блокировки:
                        </div>
                        <div class="ban-system-detail-value">Нарушение правил сообщества</div>
                    </div>
                    
                    <div class="ban-system-detail">
                        <div class="ban-system-detail-label">
                            <i class="fas fa-clock"></i>
                            Дата блокировки:
                        </div>
                        <div class="ban-system-detail-value">-----</div>
                    </div>
                    
                    <div class="ban-system-detail">
                        <div class="ban-system-detail-label">
                            <i class="fas fa-id-card"></i>
                            Ваш ID:
                        </div>
                        <div class="ban-system-detail-value">@yourClientID</div>
                    </div>
                </div>
                
                <div class="ban-system-message">
                    <p>К сожалению, вы не можете участвовать в чате. Если считаете, что это ошибка, обратитесь в техподдержку.</p>
                </div>
                
                <div class="ban-system-actions">
                    <button class="ban-system-btn ban-system-secondary" @onclick="BanReboot_Btn">
                        <i class="fas fa-sync-alt"></i>
                        Перезагрузить
                    </button>
                    <button class="ban-system-btn ban-system-primary" @onclick="BanSendTechSupport_Btn">
                        <i class="fas fa-headset"></i>
                        Техподдержка
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@* Toast уведомление *@
<div class="toast-container @(ShowToast ? "show" : "")">
    <div class="toast-message">
        <i class="fas fa-check-circle"></i>
        ✅ Ваша заявка принята
    </div>
</div>



