@page "/"
@using Microsoft.AspNetCore.SignalR.Client
@using System.Security.Cryptography
@using System.Text
@using System.Net
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@inject NavigationManager Navigation
@inject ProtectedLocalStorage _protectedLocalStorage
@rendermode InteractiveServer


<div class="chat-container">
    <div class="status-panel">
        <div class="status-indicator">
            <span class="status-dot"></span>
            Статус подключения: @hubConnection?.State
        </div>
        <div class="client-id">
            <span class="icon-user">👤</span>
            Ваш ConnectionId: @yourClientID
        </div>
    </div>

    <div class="chat-window">
        <div class="chat-header">
            <h3>💬 Окно чата</h3>
            <div class="chat-status">Активен</div>
        </div>
        <div class="chat-messages" id="chatMessages">
            @if (receiveUserMessage != null && receiveUserMessage.Any())
            {
                foreach (var receiveMsg in receiveUserMessage )
                {
                    if (receiveMsg.isMine)
                    {
                        <div class="message-item : message-sent">
                            <div class="message-bubble-chat">
                                <div class="message-text">@receiveMsg.message</div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="message-item : message-received">
                            <div class="message-bubble-chat">
                                <div class="message-text">@receiveMsg.message</div>
                            </div>
                        </div>
                    }
                }
            }
            else
            {
                <div class="empty-chat">
                    <div class="empty-icon">💭</div>
                    <div class="empty-text">Начните беседу...</div>
                </div>
            }
        </div>
    </div>

    <div class="input-section">
        <div class="input-group">
            <label class="input-label">Ваше сообщение:</label>
            <textarea 
                @bind="messagetext" 
                class="message-input" 
                placeholder="Напишите сообщение...">
            </textarea>
        </div>

        <div class="input-group">
            <label class="input-label">ID получателя:</label>
            <textarea 
                @bind="interviewerСlientID" 
                class="id-input" 
                placeholder="Впишите ID получателя...">
            </textarea>
        </div>

        <button 
            @onclick="SendTestMessage" 
            class="send-button"
            disabled="@(hubConnection?.State != HubConnectionState.Connected)">
            <span class="button-icon">📨</span>
            Отправить сообщение
        </button>
    </div>
</div>
@code {
    private HubConnection? hubConnection;   
    public List<(string message, bool isMine)> receiveUserMessage = new List<(string message, bool isMine)>();
    public string yourClientID;
    public string interviewerСlientID;
    public string messagetext;
    public byte[]? publicKeyFromServer;
    public string userIp = "";
    
    
    List<TimeSpan> reconnectTime = new List<TimeSpan>();
    RSA _rsa;
    
    protected override async Task OnInitializedAsync()
    {
        
        for (int i = 0; i < 3; i++)
        {
            reconnectTime.Add(TimeSpan.FromSeconds(i*5));
        }
        
        hubConnection = new HubConnectionBuilder()
            .WithUrl(Navigation.ToAbsoluteUri("/simplehub"))
            .WithAutomaticReconnect(reconnectTime.ToArray())
            .Build();
        
        _rsa = RSA.Create(1024);
        
        await hubConnection.StartAsync();
        
        hubConnection.On<byte[], byte[], byte[]>("ReceiveMessage", (encryptedMessage, encryptedAesKey, aesIV) => 
        {
            InvokeAsync(() =>
            {
                try
                {
                    var aesKey = _rsa.Decrypt(encryptedAesKey, RSAEncryptionPadding.OaepSHA256);
                    
                    var decryptedMessage = Decrypt(encryptedMessage, aesKey, aesIV);
                    
                    receiveUserMessage.Add((decryptedMessage, false));
                    Console.WriteLine($"Received: {decryptedMessage}");
                    StateHasChanged();
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error decrypting message: {ex.Message}");
                }
            }); 
        });

        hubConnection.On<string>("ReceiveUserIp", (UserIp) =>
        {
            InvokeAsync(() =>
            {
                userIp = UserIp;
                if (userIp=="::1")
                {
                    userIp = "127.0.0.1";
                }
            });
            
        });
        
        hubConnection.On<string>("ReceivePublicKey", (publicKey) => 
        {
            InvokeAsync(() =>
            {
                publicKeyFromServer = Convert.FromBase64String(publicKey);
                Console.WriteLine($"Received public key");
                StateHasChanged();
            }); 
        });
        
        interviewerСlientID= hubConnection.ConnectionId;
        yourClientID = hubConnection.ConnectionId;
        
        await hubConnection.InvokeAsync("GetPublicKey");
        
        await hubConnection.InvokeAsync("GetUserIp");
        
        var rsaPublicKey = _rsa.ExportRSAPublicKey();
        
        await hubConnection.InvokeAsync("ReceiveRSAkey", rsaPublicKey);
        
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await CreateOrIdentify();
        }
    }

    private async Task SendTestMessage()
    {
        receiveUserMessage.Add((messagetext,true));  
        
        if (hubConnection?.State == HubConnectionState.Connected)
        {
            try
            {
                using (Aes aes=Aes.Create())
                {
                    var AesKey = aes.Key;
                    var AesIV = aes.IV;
                    var EncryptMsg = Encrypt(messagetext, AesKey, AesIV);
                    
                    while (publicKeyFromServer==null)
                    {
                        await Task.Delay(100);
                    }
                    using (RSA rsa = RSA.Create())
                    {
                        rsa.ImportRSAPublicKey(publicKeyFromServer,  out _);
                        var AesKeyEncryptedbyRsa = rsa.Encrypt(AesKey, RSAEncryptionPadding.OaepSHA256);
                        await hubConnection.InvokeAsync("SendToClient", interviewerСlientID, EncryptMsg, AesKeyEncryptedbyRsa, AesIV);
                    }
                }
            }
            catch (Exception e)
            {
                Console.WriteLine(e);
                throw;
            }
        }
        messagetext = "";
    }
    
    public async Task CreateOrIdentify()
    {
        var userGuidLocalStorage = await _protectedLocalStorage.GetAsync<string>("user_id");
        var userIpLocalStorage = await _protectedLocalStorage.GetAsync<string>("user_ip");
        var clientIP = userIp;
        var userGuid = Guid.NewGuid().ToString();
        string sessionId = $"{clientIP}_{userGuidLocalStorage.Value}";
        
        if (String.IsNullOrEmpty(userGuidLocalStorage.Value) && String.IsNullOrEmpty(userIpLocalStorage.Value))
        {
            
            _protectedLocalStorage.SetAsync("user_ip", clientIP);
            _protectedLocalStorage.SetAsync("user_id",userGuid);
            
            sessionId = $"{clientIP}_{userGuid}";
            Console.WriteLine($"Ваш SessionID:{sessionId}");
        }
        else
        {
            Console.WriteLine($"вы уже в системе: {sessionId}");
        }
        
    }
    
    
    public static byte[] Encrypt(string text, byte[] key, byte[] iv)
    {
        using (Aes aes=Aes.Create())
        {
            aes.Key = key;
            aes.IV = iv;
            using (ICryptoTransform encryptor= aes.CreateEncryptor(aes.Key,aes.IV))
            {
                using (MemoryStream ms=new MemoryStream())
                {
                    using (CryptoStream cs=new CryptoStream(ms, encryptor, CryptoStreamMode.Write))
                    {
                        using (StreamWriter sw=new StreamWriter(cs))
                        {
                            sw.Write(text);
                        }
                    }

                    return ms.ToArray();
                }
            }
        }
    }
    
   
    
    public static string Decrypt(byte[] text, byte[] key, byte[] iv)
    {
        using (Aes aes=Aes.Create())
        {
            aes.Key = key;
            aes.IV = iv;
            using (ICryptoTransform decryptor=aes.CreateDecryptor(aes.Key,aes.IV))
            {
                using (MemoryStream ms=new MemoryStream(text))
                {
                    using (CryptoStream cs=new CryptoStream(ms, decryptor, CryptoStreamMode.Read))
                    {
                        using (StreamReader sr=new StreamReader(cs))
                        {
                            return sr.ReadToEnd();
                        }
                    }
                }
            }
        }
    }
    
}